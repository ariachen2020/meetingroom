# 會議室預約系統 - 備份系統實作記錄

## 目標
為 Zeabur 部署的會議室預約系統實作完整的 SQLite 資料庫備份機制，包含：
1. 自動化備份腳本
2. 定時任務設定
3. 備份監控功能
4. Docker 配置更新
5. 修復月曆時段顯示問題

---

## 實作內容

### 1. 備份腳本 (`scripts/backup.sh`)

```bash
#!/bin/bash
# 主要功能：
- 創建帶時間戳的 SQLite 備份檔案
- SQLite 完整性檢查驗證 (PRAGMA integrity_check)
- 自動清理超過設定天數的舊備份
- 完整的日誌記錄與彩色輸出
- 備份統計資訊顯示

# 使用環境變數：
- DB_PATH: 資料庫路徑 (預設: /app/data/booking.db)
- BACKUP_DIR: 備份目錄 (預設: /app/backups)
- BACKUP_RETENTION_DAYS: 保留天數 (預設: 30)
- LOG_FILE: 日誌檔案路徑
```

### 2. 定時任務設定 (`scripts/crontab`)

```cron
# 每天凌晨 2:00 自動備份
0 2 * * * /app/scripts/backup.sh >> /app/backups/cron.log 2>&1

# 每週日凌晨 3:00 驗證備份完整性
0 3 * * 0 /app/scripts/verify-backups.sh >> /app/backups/verify.log 2>&1
```

### 3. 備份驗證腳本 (`scripts/verify-backups.sh`)

```bash
# 功能：
- 檢查最近備份的存在性和新鮮度
- 驗證備份檔案完整性
- 檢查備份排程合規性
- 生成備份統計報告
- 清理舊的日誌檔案

# 檢查項目：
- 備份目錄存在性
- 3 天內是否有備份
- SQLite 完整性驗證
- 過去 7 天的備份覆蓋率
```

### 4. 監控腳本 (`scripts/monitor-backups.sh`)

```bash
# 功能：
- 系統健康檢查 (磁碟空間、權限、工具可用性)
- 備份新鮮度監控 (26 小時內必須有備份)
- 即時備份完整性檢查
- 健康狀態 JSON 報告
- 備份統計儀表板

# 使用方式：
./monitor-backups.sh health    # 完整健康檢查
./monitor-backups.sh status    # 顯示備份狀態
```

### 5. 遷移修復腳本 (`scripts/fix-migration.sh`)

```bash
# 解決 Prisma 遷移問題：
- 自動檢查 order_index 欄位是否存在
- 手動添加缺失的資料庫欄位
- 多層備援機制：migrate deploy → db push → 手動 SQL
- 重新生成 Prisma client

# 修復策略：
1. 檢查欄位存在性: PRAGMA table_info(bookings)
2. 手動添加: ALTER TABLE bookings ADD COLUMN order_index
3. Prisma 遷移: prisma migrate deploy
4. 強制同步: prisma db push --accept-data-loss
```

---

## Docker 配置更新

### Dockerfile 修改

```dockerfile
# 安裝系統依賴
RUN apk add --no-cache \
    sqlite \
    dcron \
    tini

# 複製並設定腳本權限
COPY scripts/backup.sh /app/scripts/backup.sh
COPY scripts/verify-backups.sh /app/scripts/verify-backups.sh
COPY scripts/monitor-backups.sh /app/scripts/monitor-backups.sh
COPY scripts/fix-migration.sh /app/scripts/fix-migration.sh
COPY scripts/crontab /etc/cron.d/backup-cron

RUN chmod +x /app/scripts/*.sh \
    && chmod 0644 /etc/cron.d/backup-cron \
    && crontab /etc/cron.d/backup-cron

# 使用 tini 作為 init 系統
ENTRYPOINT ["/sbin/tini", "--"]
```

### entrypoint.sh 更新

```bash
echo "Setting up database..."
# 執行遷移修復腳本
/app/scripts/fix-migration.sh

echo "Starting backup system..."
# 啟動 cron 守護程序
crond -b -L /var/log/cron/cron.log

# 執行初始備份系統檢查
/app/scripts/monitor-backups.sh health
```

---

## Zeabur 配置 (`zeabur.yaml`)

```yaml
name: meetingroom-booking

services:
  app:
    type: dockerfile
    dockerfile: Dockerfile
    environment:
      NODE_ENV: production
      DATABASE_URL: "file:/app/data/booking.db"
      BACKUP_SCHEDULE: "0 2 * * *"
      BACKUP_RETENTION_DAYS: "30"
    volumes:
      - data:/app/data        # 資料庫持久化
      - backups:/app/backups  # 備份檔案持久化
```

---

## 問題解決記錄

### 問題 1: Prisma 遷移失敗
**症狀**: `Unknown argument 'orderIndex'` 錯誤
**原因**: Prisma client 快取未更新
**解決方案**:
```bash
# 1. 清理 Prisma client 快取
rm -rf node_modules/.prisma node_modules/@prisma/client

# 2. 重新生成 client
npx prisma generate

# 3. 重啟應用程序
```

### 問題 2: 本地與生產環境不同步
**症狀**: 本地正常但 Zeabur 部署失敗
**原因**: 遷移文件未正確套用
**解決方案**: 創建 `fix-migration.sh` 自動修復腳本

### 問題 3: 月曆時段顯示消失
**症狀**: 月曆上看不到預約時段標籤
**原因**: 資料庫 schema 中 `order_index` 欄位缺失
**解決方案**:
```sql
-- 手動添加欄位
ALTER TABLE bookings ADD COLUMN order_index INTEGER NOT NULL DEFAULT 1;

-- 創建索引
CREATE INDEX bookings_room_id_date_time_slot_order_index_idx
ON bookings(room_id, date, time_slot, order_index);
```

---

## 部署流程

### 1. 本地開發
```bash
# 1. 開發功能
git add .
git commit -m "feat: Add backup system"

# 2. 測試本地環境
npm run dev

# 3. 驗證功能正常
```

### 2. Zeabur 部署
```bash
# 1. 推送到遠端
git push

# 2. Zeabur 自動部署
# 3. 執行 fix-migration.sh 修復資料庫
# 4. 啟動備份系統
# 5. 驗證功能
```

---

## 備份系統監控

### 健康檢查端點
- **備份狀態檢查**: `/app/scripts/monitor-backups.sh status`
- **完整健康檢查**: `/app/scripts/monitor-backups.sh health`
- **健康狀態檔案**: `/app/backups/.health_status`

### 日誌檔案
- **備份日誌**: `/app/backups/backup.log`
- **驗證日誌**: `/app/backups/verify.log`
- **監控日誌**: `/app/backups/monitor.log`
- **Cron 日誌**: `/var/log/cron/cron.log`

### 監控指標
- ✅ **每日備份**: 凌晨 2:00 自動執行
- ✅ **完整性檢查**: 每個備份檔案都經過驗證
- ✅ **自動清理**: 30 天後自動刪除舊備份
- ✅ **健康監控**: 26 小時內必須有備份
- ✅ **磁碟監控**: 備份目錄可用空間檢查

---

## 成功實作功能

### ✅ 已完成
1. **SQLite 備份腳本** - 自動備份與完整性驗證
2. **Cron 定時任務** - 每日自動備份排程
3. **備份監控功能** - 健康檢查與統計報告
4. **Docker 配置** - 完整的容器化備份系統
5. **遷移修復機制** - 自動解決資料庫 schema 問題
6. **Zeabur 部署配置** - 持久化儲存與環境變數設定

### ✅ 問題修復
1. **月曆時段顯示** - 修復 `order_index` 欄位問題
2. **Prisma 遷移** - 多層備援機制確保資料庫正常
3. **本地開發環境** - 重新生成 client 並重啟服務

---

## 使用說明

### 本地開發測試
```bash
# 1. 測試備份腳本
LOG_FILE="/tmp/backup.log" DB_PATH="prisma/data/booking.db" BACKUP_DIR="/tmp/backups" ./scripts/backup.sh

# 2. 測試監控腳本
BACKUP_DIR="/tmp/backups" ./scripts/monitor-backups.sh health

# 3. 測試遷移修復
./scripts/fix-migration.sh
```

### Zeabur 生產環境
- **自動備份**: 每天凌晨 2:00 自動執行
- **手動備份**: 容器內執行 `/app/scripts/backup.sh`
- **健康檢查**: 容器內執行 `/app/scripts/monitor-backups.sh health`
- **備份檔案**: 存儲在 Zeabur 持久化卷 `/app/backups/`

---

## 備註

### NPM 警告說明
部署過程中出現的警告不影響系統運行：
- `rimraf@3.0.2 deprecated` - 檔案刪除工具，功能正常
- `eslint@8.57.1 deprecated` - 程式碼檢查工具，不影響運行時
- `inflight@1.0.6 memory leak` - 內部依賴，影響微小

### 後續維護
- 定期檢查備份日誌
- 監控磁碟空間使用量
- 根據需要調整備份保留天數
- 定期驗證備份還原功能

---

**實作完成時間**: 2025-09-29
**開發環境**: Next.js 14.2.33 + Prisma + SQLite
**部署平台**: Zeabur
**備份策略**: 每日自動備份，30天保留，完整性驗證